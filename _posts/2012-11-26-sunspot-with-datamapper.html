---
published: true
title: "Sunspot with Datamapper"
subtitle: Search with My Favorite ORM
author: Tony Pitale
created_at: 2012-11-26 13:01:00.000000 -04:00
layout: post
---

<p>
  Expanding search beyond simple queries is not easy. I tend to be lazy. For a long time this meant chaining queries and just letting PostgreSQL sort it all out, adding indexes along the way. This all falls down of course when we need to find one word – or part of one – within a body of text. Even worse is joining across tables all with one query. It can get very ugly, very quickly.
</p>
<p>
  Thankfully, I had read about <a href="http://outoftime.github.com/sunspot/">Sunspot</a>, a well-designed wrapper around the powerful Solr search daemon. To get started, I watched the excellent introductory <a href="http://railscasts.com/episodes/278-search-with-sunspot">"Search with Sunspot" Railscast</a> by Ryan Bates (you should really <a href="http://railscasts.com/pro">buy a pro account</a>, it's worth every penny).
</p>

<p>
  Unfortunately, out-of-the-box, Sunspot comes with ActiveRecord support and not much mention of other ORM's in the documentation. Here's what's working for me.
</p>

<h3>Install and Setup</h3>

<p>
  Installation is cake. Simply add <span class="inline-code">gem "sunspot_rails"</span> to your Gemfile as in any other case, and <span class="inline-code">bundle install</span> away.
</p>

<p>
  Thanks to <a href="http://gist.github.com/1291094">a gist by Dan Kubb</a>, there is an example of how to create an adapter for DataMapper to work with Sunspot. I <a href="http://gist.github.com/1291094">forked it and added a few more pieces</a> that seem to be required for it to work.
</p>

<p>
  After the adapter is in place, we can generate the Sunspot configuration with <span class="inline-code">script/rails generate sunspot_rails:install</span>. We'll want to be sure to add <span class="inline-code">solr/data</span> to our .gitignore file.
</p>

<h3>Model Configuration</h3>

<p>
  To get our models set to be indexed, we can simply follow Sunspot's README and configure our models using a <span class="inline-code">searchable</span> block. <a href="https://gist.github.com/4146210">Here's what I'm using to search a Problem class</a>, though it uses a lot of "text" fields. Many more, better examples can be found in the Sunspot docs.
</p>

<h3>Searching</h3>

<p>
  For some reason, I was unable to call <span class="inline-code">Problem.search {}</span> and instead I have to call <span class="inline-code">Sunspot.search(Problem) {}</span>. Happily, I like this form better. It makes it clear that I can pass in multiple model class names to search across and that I'm only really searching the Problem in this example.
</p>

<h3>Sunspot/Solr Tweaks</h3>

<p>
  I've made only a few minor modifications to solr's schema.xml configuration as generated by Sunspot. Under the solr.TextField fieldType I've added just a bit to use <a href="https://gist.github.com/4146175">PorterStemFilterFactory</a> to stem words in the index. Stemming is the process of removing common endings from words, to normalize when searching. For example, "riding" and "rides" would both be stemmed to "ride". Be careful, <a href="http://wiki.apache.org/solr/LanguageAnalysis">each language will have its own stemmer</a>.
</p>

<h3>Quirks</h3>

<p>
	Without specifying the models you wish to use explicitly, the rake tasks for Sunspot will attempt to load ActiveRecord, which we obviously do not have. The simple solution is to use <span class="inline-code">rake sunspot:index models=Problem+Task+OtherModel</span> to tell the task exactly which models we would like to be indexed.
</p>

<h3>Testing</h3>

<p>
  I would be remiss if I didn't write about how I'm testing. Stubbing is advisable in most scenarios where you don't want to actually test the functionality within Sunspot.
</p>

<p>
  However, I would also ensure the results you want are coming back from your search, a small, precise set of integration tests should be built.
</p>

<h3>In Conclusion</h3>

<p>
  I'm happy to report that, in combination, Sunspot and DataMapper get along quite beautifully and I have had no real problems with this arrangement. The declarative nature of both DataMapper and Sunspot make for models that are extremely easy to understand and maintain. Now, my search pains are eased.
</p>
